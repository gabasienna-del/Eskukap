name: Build LSPosed module (compile Java -> classes.dex, zip)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-module:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Create Android SDK directories
        run: |
          mkdir -p "${ANDROID_SDK_ROOT}"
          mkdir -p "${ANDROID_SDK_ROOT}/cmdline-tools"

      - name: Download commandline tools
        run: |
          cd "${ANDROID_SDK_ROOT}"
          curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -o cmdline-tools.zip
          unzip -q cmdline-tools.zip -d cmdline-tools_tmp
          mkdir -p cmdline-tools/latest
          mv cmdline-tools_tmp/cmdline-tools/* cmdline-tools/latest/
          rm -rf cmdline-tools.zip cmdline-tools_tmp

      - name: Add sdkmanager to PATH
        run: |
          export PATH="${ANDROID_SSDK_ROOT}/cmdline-tools/latest/bin:${PATH}"
          sdkmanager --version

      - name: Install Android SDK components
        run: |
          export PATH="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${PATH}"
          yes | sdkmanager --sdk_root="${ANDROID_SDK_ROOT}" "platform-tools" "platforms;android-33" "build-tools;33.0.2"

      - name: Compile Java -> .class
        run: |
          set -e
          rm -rf out/classes
          mkdir -p out/classes

          if [ -d "app/src/main/java" ]; then
            ANDROID_JAR="${ANDROID_SDK_ROOT}/platforms/android-33/android.jar"
            find app/src/main/java -name '*.java' > /tmp/java_files.txt
            if [ -s /tmp/java_files.txt ]; then
              javac -source 11 -target 11 -bootclasspath "${ANDROID_JAR}" -classpath "${ANDROID_JAR}" -d out/classes @/tmp/java_files.txt
            else
              echo "No Java files to compile"
            fi
          else
            echo "No app/src/main/java directory"
          fi

      - name: Convert classes -> classes.dex
        run: |
          BUILD_TOOLS=$(ls -d "${ANDROID_SDK_ROOT}/build-tools/"* | sort -V | tail -n1)
          D8="${BUILD_TOOLS}/d8"
          rm -rf out/module
          mkdir -p out/module

          if [ -d out/classes ] && [ "$(find out/classes -name '*.class' | wc -l)" -gt 0 ]; then
            $D8 --output out/module out/classes
          else
            echo -n > out/module/classes.dex
          fi

      - name: Copy smali into module
        run: |
          if [ -d "smali" ]; then
            cp -r smali out/module/
          fi

      - name: Create module.prop
        run: |
          cat > out/module/module.prop << 'EOF2'
id=CamYan
name=CamYan Hook
version=1.0
versionCode=1
author=Gabit
description=Hook module (ESKUKAP)
EOF2

      - name: Build ZIP module
        run: |
          SHA=$(git rev-parse --short HEAD)
          ZIPNAME="CamYan-module-\${SHA}.zip"
          cd out
          zip -r "../\${ZIPNAME}" module
          cd ..

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CamYan-module
          path: CamYan-module-*.zip
